/*
 * This file represents the UI for the Patient Panel.
 * This UI consists of list of patient's having the appointment for the day along with the time and an option to tag-in.
 */
/*
 * File: app/view/patientPanel.js
 *
 * This file was generated by Sencha Architect version 2.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.1.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

var tplPatientId="";
var patientInfo="";
var uniqueId="";


Ext.define('MyApp.view.patientPanel', {
    extend: 'Ext.Container',

    config: {
        id: 'patientPanel',
        layout: {
            type: 'fit'
        },
        items: [
            {
                xtype: 'panel',
                id: 'ppcontainer',
                style: '',
                layout: {
                    type: 'vbox'
                },
                items: [
                    {
                        xtype: 'panel',
                        flex: 0,
                        docked: 'top',
                        height: 100,
                        style: 'margin-top:5%;',
                        layout: {
                            type: 'hbox'
                        },
                        items: [
                            {
                                xtype: 'component',
                                centered: true,
                                html: '<img src="images/high/logo.png" />'
                            }
                        ]
                    },
                    {
                        xtype: 'panel',
                        cls: [
                            'newdatesection'
                        ],
                        height: 70,
                        padding: '0 10 0 10',
                        style: '',
                        layout: {
                            type: 'hbox'
                        },
                        items: [
                            {
                                xtype: 'panel',
                                cls: [
                                    'calendar'
                                ],
                                id: '',
                                itemId: 'mypanel13',
                                margin: '0 0 0 20',
                                width: 50,
                                items: [
                                    {
                                        xtype: 'label',
                                        id: 'cal',
                                        itemId: 'mylabel6',
                                        listeners: [
                                            {
                                                fn: function(element, options) {
                                                    var currentTime = new Date();

                                                    val = Ext.util.Format.date(currentTime, 'd');
                                                    val2 = Ext.util.Format.date(currentTime, 'F');
                                                    val3 = Ext.util.Format.date(currentTime, 'Y');
                                                    var label = Ext.getCmp('cal');
                                                    var label2 = Ext.getCmp('day');
                                                    var label3 = Ext.getCmp('year');
                                                    label.setHtml(val);
                                                    label2.setHtml(val2);
                                                    label3.setHtml(val3);

                                                },
                                                event: 'painted'
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                xtype: 'panel',
                                flex: 1,
                                layout: {
                                    type: 'vbox'
                                },
                                items: [
                                    {
                                        xtype: 'label',
                                        cls: [
                                            'dates'
                                        ],
                                        id: 'day'
                                    },
                                    {
                                        xtype: 'label',
                                        cls: [
                                            'dates2'
                                        ],
                                        id: 'year'
                                    }
                                ]
                            },
                            {
                                xtype: 'panel',
                                flex: 1,
                                items: [
                                    {
                                        xtype: 'label',
                                        id : 'hcpname',
                                        cls: [
                                            'username'
                                        ],
                                        html: 'firstName'
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        xtype: 'panel',
                        cls: [
                            'datetimesection'
                        ],
                        height: 50,
                        hidden: true,
                        style: 'margin-bottom:10px;',
                        layout: {
                            type: 'vbox'
                        },
                        items: [
                            {
                                xtype: 'panel',
                                height: 25,
                                layout: {
                                    type: 'hbox'
                                },
                                items: [
                                    {
                                        xtype: 'label',
                                        flex: 0.5,
                                        cls: [
                                            'visitdatelabel'
                                        ],
                                        html: 'Visit Date:',
                                        style: 'margin-left:20px;'
                                    },
                                    {
                                        xtype: 'label',
                                        flex: 1,
                                        cls: [
                                            'visitdate'
                                        ],
                                        html: 'Username',
                                        style: 'text-align:right;margin-right:20px;'
                                    }
                                ]
                            },
                            {
                                xtype: 'panel',
                                height: 25,
                                layout: {
                                    type: 'hbox'
                                },
                                items: [
                                    {
                                        xtype: 'label',
                                        flex: 0.7,
                                        cls: [
                                            'visitdate'
                                        ],
                                        html: 'Date',
                                        id: 'date',
                                        itemId: 'date',
                                        style: 'margin-left:20px;',
                                        listeners: [
                                            {
                                                fn: function(element, options) {
                                                    var currentTime = new Date();

                                                    val = Ext.util.Format.date(currentTime, 'F d, Y');
                                                    var label = Ext.getCmp('date');
                                                    label.setHtml(val);

                                                },
                                                event: 'painted'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'label',
                                        flex: 1,
                                        cls: [
                                            'visitdate'
                                        ],
                                        style: 'text-align:right;margin-right:20px;'
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        xtype: 'panel',
                        flex: 1,
                        cls: [
                            'patientsection'
                        ],
                        id: 'patientpanel',
                        itemId: 'mypanel6',
                        padding: '0 30 0 30',
                        style: '',
                        layout: {
                            type: 'vbox'
                        },
                        scrollable: 'directionLock: true,\r\n                          direction: \'vertical\',\r\n                          momentumEasing:  {\r\n                           momentum: {\r\n                             acceleration: 100,\r\n                             friction: 0.8\r\n                           },\r\n                           bounce: {\r\n                           acceleration: 0.0001,\r\n                           springTension: 0.9999,\r\n                           },\r\n                           minVelocity: 3\r\n                           },\r\n                           outOfBoundRestrictFactor: 0',
                        items: [
                            {
                                xtype: 'panel',
                                cls: [
                                    'headersection'
                                ],
                                layout: {
                                    type: 'fit'
                                },
                                items: [
                                    {
                                        xtype: 'label',
                                        cls: [
                                            'header'
                                        ],
                                        html: 'PATIENT PANEL'
                                    }
                                ]
                            },
                            {
                                xtype: 'dataview',
                                flex: 1,
                                cls: [
                                    'patienpanel'
                                ],
                                itemId: 'mydataview',
                                padding: '30 0 0 0',
                                emptyText: '</pre> <div class="notes-list-empty-text">No notes found.</div> <pre>',
                                /*store: {
                                    autoLoad: true,
                                    fields: ['firstname', 'lastname'],

                                    proxy: {
                                        type: 'ajax',
                                        url: 'http://204.13.110.186:9000/1/login',
                                        extraParams :{
                                                        "username" : "samathan",
                                                        "password" : "password",
                                                        "usertype" : "1"
                                        },
                                        reader: {
                                            type: 'json',
                                            rootProperty: 'patients'
                                        }
                                    }
                                },*/
                                itemTpl: [
                                          '',
                                          '        <tpl >',
                                          '            <div class="leftsection" id="{ScheduleId}" name="{patientId}">',
                                          '            ',
                                          '      <div class="list-item-title" >{firstname}</div>',
                                          '      <div class="list-item-narrative">{streetaddress}</div>          ',
                                          '            ',
                                          '</div> ',
                                          '',
                                          '<div class="timesection">',
                                          '        <div class="list-item-time" id="list-item-time{ScheduleTime}">{ScheduleTime}</div>',
                                          '</div>  ',
                                          '            ',
                                          '<button class="tagin"  id="ppaneltaginbutton" name ="{ScheduleId}" style="float:right;margin-right:10px;">TAG IN</button>',
                                          '<div style="clear:both;"></div>',
                                          ' <div class="linesection">',
                                          '<div class="lineimg"></div><div class="line"></div>',
                                          '            </div>    ',
                                          '        </tpl>',
                                          '',
                                          ''
                                      ],
                                store: 'Notes'
                            }
                        ],
                    }
                ]
            }
        ],
        listeners: [
            {
                fn: 'onMydataviewItemTap',
                event: 'itemtap',
                delegate: '#mydataview'
            }
        ]
    },

    onMydataviewItemTap: function(dataview, index, target, record, e, options) {
        if (e.getTarget('.leftsection')) {

            //The HCP clicked on the Patient name on the list, thus navigate to patient details panel.
            var paneltab = Ext.create('MyApp.view.patientdetailPanel');
            
            uniqueId=e.getTarget('.leftsection').id;
            
            Ext.getCmp('patientPanel').destroy();
            Ext.Viewport.add(paneltab);
            
            patientInfo=patientDetails[uniqueId];
            
            Ext.getCmp('patientdetail_name').setHtml(patientInfo.firstname+" "+patientInfo.lastname);
            Ext.getCmp('patientPhone').setHtml(patientInfo.phone);
            Ext.getCmp('patientaddress').setHtml(patientInfo.streetaddress+", "+patientInfo.city+", "+patientInfo.state+" "+patientInfo.zipcode);
            Ext.getCmp('visitdatetime').setHtml(patientInfo.ScheduleTime);
            Ext.getStore('demographics').setData(patientInfo);
            
            tplPatientId = patientInfo.patientid;


        }

        if (e.getTarget('.tagin')) {

        	//HCP clicked on tag-in button. Thus set tagPage flag to 0, indicating tag-in is performed in this page.
            tagPage=0;
            
                      
            uniqueId=e.getTarget('.tagin').name;
            
            patientInfo=patientDetails[uniqueId];
            
            tplPatientId = patientInfo.patientid;
            
            Ext.getCmp('patientPanel').setMasked(
                    {
                       xtype:'loadmask',
                       message:'Awaiting NFC Tag in (Patient)',
                       fullscreen: true,
                       html:"<img src='images/loading3.gif'/><style>.x-mask{opacity: 1;}</style>",
                       indicator:false
                    });
                    
                    app.initialize(); 
                    
                    setTimeout(function() {
                    	Ext.getCmp('patientPanel').setMasked(false);
                    }, 20000);
                    
//Grab the lat and long of the current location.
                    requestPosition();                       


        }

    }

});